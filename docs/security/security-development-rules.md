# セキュリティ開発ルール

開発時に必ず守るべきセキュリティルールを領域別に定義します。

## フロントエンド・コンポーネント設計

### XSS対策

### 禁止事項

- `dangerouslySetInnerHTML`の使用は絶対禁止
- HTMLの直接埋め込み禁止
- ユーザー入力値の直接DOM操作禁止

### 必須事項

- 外部データ表示時は必ずReactの自動エスケープを使用
- 外部データを表示する場合は事前サニタイゼーション必須
- 画像・メディアファイルは信頼できるソースのみ

### CSP管理

- 新しい外部サービス使用時はCSP更新必須
- 最小権限の原則でドメイン許可

## バックエンド・tRPCエンドポイント設計

### 禁止事項

- 全件取得エンドポイントの作成禁止
- limit/offset指定なしの検索API禁止
- パラメータ化クエリを使わない生SQL禁止

### 必須事項

- 検索系APIは必ずページング必須（limit最大100）
- 入力値は必ずZodスキーマで検証
- レート制限の影響を考慮した設計
- publicProcedure/protectedProcedureの適切な使い分け

### 入力処理

- 入力値のサニタイゼーション処理
- DB保存前の必須検証
- 危険な文字列パターンの除去

## 認証・システム設計

### 機密情報管理

- APIキー・シークレットは環境変数で管理
- 45文字以上のランダム文字列を使用
- ハードコードでの機密情報埋め込み禁止

### 認証トークン管理

- CRON_SECRET等のAPIトークンは45文字以上
- トークンの定期的なローテーション
- 認証失敗時の適切なログ記録

## データベース

### 必須事項

- Drizzle ORMによるパラメータ化クエリ使用
- 入力値検証後のDB操作
- 機密データの適切な暗号化

### 禁止事項

- 動的SQL文字列の直接実行
- ユーザー入力値の直接クエリ組み込み
- DB接続情報のハードコード

## 外部サービス連携

### セキュリティ要件

- HTTPS通信の必須使用
- APIキー・トークンの適切な管理
- 外部レスポンスの検証・サニタイゼーション

### CSP管理

- 新しい外部サービス使用時はCSP更新必須
- 最小権限の原則でドメイン許可
- 定期的な許可ドメインの見直し

## エラーハンドリング

### 禁止事項

- 機密情報を含むエラーメッセージの表示禁止
- スタックトレースの本番環境での露出禁止
- データベース構造を推測できるエラー情報の漏洩禁止

### 必須事項

- 適切なログレベルでのエラー記録
- ユーザーには安全な汎用エラーメッセージを表示
- セキュリティインシデントの適切な通知

## 依存関係管理

### セキュリティ要件

- 定期的な依存関係の脆弱性チェック
- 不要なパッケージの削除
- 信頼できるソースからのパッケージ使用

### 更新ポリシー

- セキュリティアップデートの優先適用
- 破壊的変更を伴う更新時の影響評価
- 本番デプロイ前のセキュリティテスト

## コード品質

### セキュリティレビュー

- プルリクエスト時のセキュリティ観点でのレビュー
- 機密情報の誤コミット防止
- セキュリティに関わる変更の複数人承認

### 必須チェック項目

- lint・typecheck・formatの全て通過
- セキュリティテストの実行
- 機密情報漏洩チェック

## 本番デプロイ

### 事前チェック

- セキュリティヘッダーの動作確認
- レート制限の動作確認
- エラーハンドリングの動作確認

### 監視・アラート

- 異常なアクセスパターンの監視
- 認証失敗の連続発生監視
- セキュリティログの適切な保存

## インシデント対応

### 発生時の対応

- セキュリティインシデントの即座な報告
- 影響範囲の迅速な特定
- 適切な緊急対応の実施

### 事後対応

- 原因分析と再発防止策の策定
- セキュリティルールの見直し・更新
- チーム全体での知見共有

---

## APPENDIX: 認証機能があるシステムの場合

将来的にログイン機能を追加する場合の追加ルール

### セッション管理

- **セッション固定化防止**: ログイン成功時に新しいセッションIDを生成
- **適切な有効期限**: アクティブセッション30分、最大24時間で自動失効
- **ログアウト処理**: サーバー側セッション完全削除 + クライアント側Cookie削除
- **同時ログイン制限**: 同一ユーザーの複数デバイスログイン数制限
- **セッション検証**: リクエスト毎のセッション有効性チェック

### 認証フロー

- **ログイン試行制限**: 同一IPから5回失敗で15分ロック
- **パスワード要件**: 最低8文字、英数字記号組み合わせ必須
- **多要素認証**: 重要操作時のSMS/TOTP認証
- **ログイン通知**: 新デバイス・異常地点からのログイン通知
- **アカウントロック**: 連続失敗時の一時的なアカウント無効化

### トークン管理（JWT等）

- **適切な有効期限**: アクセストークン15分、リフレッシュトークン7日
- **署名検証**: 必ずトークン署名を検証
- **機密情報除外**: JWTペイロードに機密情報を含めない
- **トークンローテーション**: リフレッシュ時の古いトークン無効化
- **安全な保存**: HttpOnly Cookie でのトークン管理

### パスワード管理

- **ハッシュ化**: bcrypt/scrypt等の適切なハッシュ関数使用
- **ソルト**: ユーザー毎の一意なソルト生成
- **パスワード履歴**: 過去のパスワード再利用防止
- **強制変更**: 定期的なパスワード変更促進

### 権限・認可

- **最小権限の原則**: 必要最小限の権限のみ付与
- **ロールベースアクセス**: 明確な権限体系の構築
- **権限エスカレーション防止**: 権限昇格攻撃の対策
- **リソースアクセス制御**: オブジェクトレベルでの認可チェック

---

## ルール更新

このドキュメントは以下の場合に更新します：

- 新しい脅威や攻撃手法の発見時
- セキュリティインシデント発生後
- 技術スタックの変更時
- 定期的なセキュリティレビュー時

**最終更新**: 2025-07-04

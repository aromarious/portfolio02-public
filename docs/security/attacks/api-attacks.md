# API攻撃の詳細

## 認証バイパス

**攻撃手法**: 認証機能を迂回して不正アクセスを試みる攻撃
**特徴**:

- JWT トークンの偽造
- セッション管理の脆弱性悪用
- 認証ロジックの欠陥利用

**影響**:

- 権限のないデータアクセス
- 機密情報の漏洩
- システムの不正操作

**検出方法**:

- 認証なしでの保護リソースアクセス
- 異常なトークン使用パターン
- 認証失敗後の成功アクセス

**現状と対策**:

- 現状: better-authによるセッション管理で適切に保護
- 対策: protectedProcedureによる認証必須エンドポイント
- 結果: 認証バイパス攻撃に対して十分な防御

## パラメータ改ざん

**攻撃手法**: APIパラメータを不正に変更して権限昇格や情報取得を試みる攻撃
**特徴**:

- URLパラメータの直接変更
- JSON/XMLペイロードの改ざん
- 隠しパラメータの悪用

**影響**:

- 他ユーザーのデータアクセス
- 権限昇格
- 意図しない機能の実行

**検出方法**:

- 異常なパラメータ値の検出
- 権限外のリソースアクセス試行
- 予期しないAPI呼び出しパターン

**現状と対策**:

- 現状: Zodスキーマによる厳格な型検証で入力を制限
- 対策: contactFormInputSchemaによる入力値の検証とサニタイゼーション
- 結果: パラメータ改ざん攻撃に対して十分な防御

## N+1クエリ誘発

**攻撃手法**: 大量のデータベースクエリを実行させてサーバーリソースを枯渇
**特徴**:

- 関連データの大量取得要求
- ネストした関係データの悪用
- GraphQLクエリの複雑化

**影響**:

- データベース性能の劣化
- サーバーリソースの枯渇
- レスポンス時間の大幅な増加

**検出方法**:

- 異常なクエリ実行数
- データベース接続数の急増
- 単一リクエストでの大量データ取得

**現状と対策**:

- 現状: 単純なAPI設計により大規模なN+1攻撃は困難
- 対策: 全件取得エンドポイント禁止、関連データ最小化設計
- 結果: 現在の構成では十分安全、レート制限で追加防御

## 大量データ取得

**攻撃手法**: 重い処理や大量のデータ取得を要求してサーバーに負荷をかける攻撃
**特徴**:

- ページング制限の悪用
- 大量のフィルタリング要求
- 重い集計処理の実行

**影響**:

- サーバーCPU/メモリの枯渇
- 他ユーザーへの影響
- サービス応答性の低下

**検出方法**:

- 異常に大きなレスポンスサイズ
- 長時間のクエリ実行
- 同一ユーザーからの連続した重い要求

**現状と対策**:

- 現状: resyncUnsyncedでlimit最大100に制限済み
- 対策: 全件取得エンドポイント作成禁止、必須ページング設計
- 結果: 大量データ取得攻撃に対して十分な防御

---

## API攻撃対策（設計原則）

### 防御策

- **全件取得エンドポイント禁止**: 必ずlimit/offsetでページング必須
- **大量データ取得制限**: 単一リクエストでの大量データ取得を避ける
- **関連データ最小化**: 必要最小限のリレーションのみ取得
- **集計系は事前計算**: リアルタイム集計ではなく事前計算済みデータを返す

### 現在の設計状況

- contact.submit: 単一作成のみ
- contact.resyncUnsynced: limit最大100で制限済み
- auth系: 単一データ取得のみ
- N+1攻撃に対して安全な設計

### 今後のAPI設計時の注意点

- 検索系APIは必ずlimit/offset必須
- 大量データ取得の可能性があるエンドポイントは作らない
- レート制限で対応可能なレベルに抑える

### 実装レベルでの対策

- **レート制限**: 既存のRateLimitRepositoryを活用
- **入力検証**: Zodスキーマによる型安全性確保
- **認証・認可**: protectedProcedureによる適切な権限管理

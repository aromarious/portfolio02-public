# Webアプリケーション セキュリティ・ガイド

## 概要

現代のWebアプリケーションは、様々な脅威にさらされています。本ガイドでは、一般的な攻撃の種類から始まり、それらに対する効果的な防御戦略を技術スタック別に解説します。

## 1. 一般的なWeb攻撃の種類

### 1.1 DDoS攻撃（Distributed Denial of Service）

#### **ネットワーク層攻撃（L3/L4）**

- **特徴**: 大量のパケットでネットワーク帯域を飽和させる
- **例**: UDP Flood、SYN Flood、ICMP Flood
- **影響**: サーバー全体の可用性低下
- **検出**: 異常なトラフィック量、接続数の急増

#### **アプリケーション層攻撃（L7）**

- **特徴**: 正常なHTTPリクエストに見せかけた攻撃
- **例**: HTTP Flood、Slowloris、POST攻撃
- **影響**: アプリケーションロジックの過負荷
- **検出**: リクエストパターンの異常、レスポンス時間の増加

### 1.2 Bot攻撃

#### **悪意のあるBot**

- **特徴**: 自動化されたスクリプトによる攻撃
- **例**: スクレイピング、ブルートフォース、スパム投稿
- **影響**: サーバーリソース消費、データ漏洩
- **検出**: User-Agent、リクエスト間隔、行動パターン

#### **レート制限回避Bot**

- **特徴**: IPローテーション、分散リクエスト
- **例**: プロキシ経由攻撃、分散型Bot
- **影響**: 従来のレート制限の無効化
- **検出**: 地理的分散、異常なセッション パターン

### 1.3 API直接攻撃

#### **エンドポイント攻撃**

- **特徴**: 公開APIエンドポイントへの直接攻撃
- **例**: 認証バイパス、パラメータ改ざん、SQL injection
- **影響**: データ漏洩、不正操作
- **検出**: 異常なAPIコール、認証失敗の急増

#### **データベース負荷攻撃**

- **特徴**: 重いクエリを実行させるリクエスト
- **例**: N+1クエリ誘発、大量データ取得
- **影響**: データベース性能劣化
- **検出**: クエリ実行時間、DB接続数の異常

### 1.4 認証・認可攻撃

#### **ブルートフォース攻撃**

- **特徴**: パスワードやAPIキーの総当たり
- **例**: ログイン試行、トークン推測
- **影響**: アカウント乗っ取り
- **検出**: 連続する認証失敗

#### **セッション攻撃**

- **特徴**: セッション管理の脆弱性を悪用
- **例**: セッション固定、セッションハイジャック
- **影響**: 権限昇格、なりすまし
- **検出**: 異常なセッション活動

### 1.5 コード注入攻撃

#### **XSS（Cross-Site Scripting）**

- **特徴**: 悪意のあるスクリプトをWebページに注入
- **種類と例**:
  - **Reflected XSS（反射型）**: URL パラメータ経由のスクリプト注入
  - **Stored XSS（格納型）**: データベースに保存されたスクリプトの実行
  - **DOM-based XSS**: JavaScript実行時のDOM操作による注入
- **影響**: セッション乗っ取り、個人情報窃取、フィッシング
- **検出**: 入力値の異常なスクリプトタグ、JavaScript実行パターン

#### **SQL Injection**

- **特徴**: SQLクエリに悪意のあるコードを注入
- **例**: `'; DROP TABLE users; --`、UNION攻撃
- **影響**: データベース情報漏洩、データ改ざん、権限昇格
- **検出**: 異常なSQL構文、データベースエラーの増加

#### **Command Injection**

- **特徴**: OSコマンドの実行を試行
- **例**: `; rm -rf /`、バックティック注入
- **影響**: サーバー制御奪取、ファイル操作
- **検出**: システムコマンド文字列、プロセス実行の異常

#### **Template Injection**

- **特徴**: テンプレートエンジンの脆弱性を悪用
- **例**: `{{7*7}}`、`${process.env}`
- **影響**: サーバーサイドコード実行
- **検出**: テンプレート構文の異常な使用

## 2. 防御手法の比較

### 2.1 CDN（Content Delivery Network）

#### **Cloudflare**

```
✅ 強力なDDoS保護（L3/L4/L7）
✅ Bot管理機能
✅ WAF（Web Application Firewall）
✅ エッジでのレート制限
✅ 地理的分散
⚠️ 設定の複雑さ
💰 高度な機能は有料
```

#### **Vercel Edge Network**

```
✅ 自動DDoS保護
✅ Next.js最適化
✅ Edge Functions対応
✅ 簡単設定
❌ カスタマイズ制限
❌ 高度なWAF機能なし
```

#### **AWS CloudFront**

```
✅ 企業級スケール
✅ AWS WAF統合
✅ 詳細な設定可能
✅ 他AWSサービス連携
⚠️ 設定複雑
💰 高コスト
```

### 2.2 アプリケーション層保護

#### **Arcjet**

```
✅ リアルタイム脅威検出
✅ Bot保護
✅ レート制限
✅ 攻撃分析
✅ Edge環境対応
⚠️ 比較的新しいサービス
💰 利用量課金
```

#### **@upstash/ratelimit**

```
✅ サーバーレス最適化
✅ Redis基盤
✅ スライディングウィンドウ
✅ 分析機能
❌ レート制限のみ
❌ Bot検知なし
```

#### **trpc-limiter**

```
✅ tRPC専用設計
✅ 複数バックエンド対応
✅ TypeScript完全対応
❌ tRPCでのみ利用可能
❌ 汎用性低い
```

### 2.3 インフラ層保護

#### **API Gateway**

```
✅ 統一的なアクセス制御
✅ 認証・認可
✅ レート制限
✅ ログ・監視
⚠️ 追加インフラ必要
💰 運用コスト
```

#### **WAF（Web Application Firewall）**

```
✅ SQL injection保護
✅ XSS保護
✅ OWASP Top10対応
✅ カスタムルール
⚠️ 誤検知リスク
💰 高コスト
```

### 2.4 コード注入攻撃対策

#### **入力検証・サニタイゼーション**

```
✅ リアルタイム検証
✅ 型安全性（TypeScript）
✅ スキーマ検証（Zod）
✅ 軽量・高速
❌ 複雑な攻撃の見逃し
❌ 継続的なルール更新必要
```

#### **CSP（Content Security Policy）**

```
✅ XSS攻撃の根本的防止
✅ ブラウザレベルの保護
✅ 細かい制御可能
✅ 標準化された仕様
⚠️ 設定の複雑さ
❌ 古いブラウザ未対応
```

#### **ORM/Query Builder**

```
✅ SQL injection完全防止
✅ 型安全なクエリ（Drizzle、Prisma）
✅ パラメータ化クエリ自動生成
❌ 動的クエリの制限
❌ 生SQLが必要な場合の制約
```

## 3. 技術スタック別防御戦略

### 3.1 T3スタック（Next.js + tRPC）セキュリティ

#### **防御層の構成**

```
┌─────────────────┐
│ Vercel Edge     │ ← 自動DDoS保護、CDN
├─────────────────┤
│ Next.js         │ ← ミドルウェア、セキュリティヘッダー
│ Middleware      │   CSP、レート制限
├─────────────────┤
│ tRPC Endpoints  │ ← 型安全なAPI保護
│                 │   入力検証、レート制限
├─────────────────┤
│ Drizzle ORM     │ ← SQL injection防止
│                 │   パラメータ化クエリ
└─────────────────┘
```

#### **主要な実装アプローチ**

**レート制限戦略**

- Next.js Middleware: 全体的なリクエスト制限
- tRPC Procedure: エンドポイント別の詳細制限
- Redis（Upstash）: 分散環境での状態管理

**XSS対策**

- CSP（Content Security Policy）: ブラウザレベルでの防御
- Zod Schema: 入力時の検証・サニタイゼーション
- DOMPurify: 表示時のHTMLサニタイゼーション

**SQL Injection対策**

- Drizzle ORM: 自動的なパラメータ化クエリ
- 型安全性: TypeScriptによるコンパイル時チェック
- 生SQLの制限: 必要時のみ安全な方法で使用

### 3.2 Railway + Express.js環境

#### **Arcjet統合による包括的保護**

**主要機能**

- **Bot検知**: 機械学習による高精度な判定
- **レート制限**: 分散環境でのトークンバケット
- **Shield**: リアルタイム攻撃パターン検知

**実装の特徴**

- Express.js ミドルウェア形式での統合
- 柔軟なルール設定とカスタマイズ
- 詳細な分析とログ機能

#### **防御パターン**

```
┌─────────────────┐
│ Railway CDN     │ ← インフラ層DDoS保護
├─────────────────┤
│ Arcjet          │ ← AI駆動の脅威検知
│ Protection      │   Bot管理、レート制限
├─────────────────┤
│ Express.js      │ ← アプリケーション層制御
│ Middleware      │   認証、認可、ログ
├─────────────────┤
│ Database        │ ← 接続プール制限
│ Connection      │   RLS、アクセス制御
└─────────────────┘
```

## 4. 多層防御戦略

### 4.1 防御層の役割分担

#### **第1層: CDN/Edge**

- **役割**: 大量トラフィックの分散、基本的なDDoS保護
- **対象**: 静的ファイル、キャッシュ可能コンテンツ
- **限界**: 動的コンテンツ、複雑な攻撃の検知困難

#### **第2層: アプリケーション**

- **役割**: ビジネスロジック保護、詳細な制御
- **対象**: API、フォーム、認証エンドポイント
- **限界**: インフラ層攻撃への対応不可

#### **第3層: データベース**

- **役割**: データ保護、接続制限
- **対象**: SQLクエリ、データアクセス
- **限界**: アプリケーション層を通過した攻撃のみ

### 4.2 実用的な構成例

#### **ポートフォリオサイト（低〜中トラフィック）**

```
┌─────────────┐
│ Vercel CDN  │ ← 静的ファイル配信
└─────────────┘
        │
┌─────────────┐
│ Next.js     │ ← @upstash/ratelimit
│ Middleware  │   軽めのレート制限
└─────────────┘
        │
┌─────────────┐
│ API Routes  │ ← 個別エンドポイント制限
└─────────────┘
        │
┌─────────────┐
│ Database    │ ← 接続プール制限
└─────────────┘
```

#### **実用アプリ（高トラフィック）**

```
┌─────────────┐
│ Cloudflare  │ ← L3/L4 DDoS保護
│ CDN + WAF   │   Bot管理
└─────────────┘
        │
┌─────────────┐
│ Railway     │ ← Arcjet保護
│ + Arcjet    │   詳細な脅威検知
└─────────────┘
        │
┌─────────────┐
│ tRPC        │ ← trpc-limiter
│ Endpoints   │   型安全なレート制限
└─────────────┘
        │
┌─────────────┐
│ PostgreSQL  │ ← RLS, 接続制限
└─────────────┘
```

## 5. 実装時の設計指針

### 5.1 段階的レート制限の考え方

#### **エンドポイント別の制限戦略**

- **認証系**: 厳格な制限（10回/分）
- **一般API**: 通常の制限（100回/分）
- **静的リソース**: 緩い制限（1000回/分）

#### **識別子の選択**

- **IP＋User ID**: 認証済みユーザーの識別
- **セッション**: 未認証ユーザーの追跡
- **API Key**: 外部連携の管理

### 5.2 監視とアラート設計

#### **監視対象の優先順位**

1. **クリティカル**: 認証失敗の急増
2. **重要**: レート制限違反の連続発生
3. **注意**: 異常なトラフィックパターン

#### **アラート通知戦略**

- **即座**: セキュリティ攻撃の疑い
- **定期**: 統計情報のサマリー
- **手動**: 詳細な分析レポート

### 5.3 設定管理のベストプラクティス

#### **環境別設定**

- **開発**: 制限緩和、詳細ログ
- **ステージング**: 本番相当の制限
- **本番**: 最適化された制限値

#### **動的設定調整**

- **自動**: トラフィック量に応じた調整
- **手動**: 緊急時の制限変更
- **スケジュール**: 定期的な制限見直し

## 6. 運用時の注意点

### 6.1 誤検知への対応

- **ホワイトリスト機能**: 信頼できるIPアドレスの除外
- **段階的制限**: 即座にブロックせず、徐々に制限強化
- **手動解除機能**: 緊急時の制限解除仕組み

### 6.2 パフォーマンス考慮

- **Redis接続プール**: 接続数の最適化
- **キャッシュ戦略**: レート制限状態のキャッシュ
- **非同期処理**: ログ・アラートの非同期化

### 6.3 スケーラビリティ

- **分散制限**: マルチリージョン対応
- **動的制限調整**: トラフィック量に応じた自動調整
- **負荷分散**: 複数のRedisインスタンス活用

## まとめ

Webアプリケーションのセキュリティは、単一の解決策では不十分です。攻撃の種類と特徴を理解し、適切な防御手法を組み合わせた多層防御が重要です。技術スタックや要件に応じて、最適な構成を選択し、継続的な監視と改善を行うことで、堅牢なセキュリティを実現できます。

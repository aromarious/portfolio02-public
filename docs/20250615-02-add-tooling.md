# 開発ツールの追加

このドキュメントでは[T3 Turbo](http://github.com/aromarious/t3turbo-template)を使用するにあたり、開発ツールを追加した手順を記録・説明します。

- T3 Turbo のテンプレートを使用して開発を開始する際の参考にしてください。
- このリポジトリをテンプレートとして利用される場合には、以下の設定はすでに完了している状態で提供されます。

リポジトリの作成手順は [docs/20250615-01-firststep.md](./20250615-01-firststep.md) を参照してください。

## 追加するツール

追加するツールは以下の通りです。

- [commitlint](https://commitlint.js.org/): コミットメッセージのフォーマットを統一
- [lint-staged](https://github.com/okonet/lint-staged): コミット前にコードを整形・検査
- [Docker](https://www.docker.com/): 開発環境をコンテナで統一

以下の手順に従って、コミットメッセージのフォーマット統一、コードの整形・検査、Docker環境の設定を行います。

## T3 Turbo の tooling について

`package.json`では、パッケージ名のプロパティはそのパッケージの設定として扱われます。文字列の場合は、設定を提供するパッケージ名として扱われます。

T3 Turbo ではこのことを利用し、開発ツールの設定をパッケージとして提供し、ツール側でパッケージを設定として参照する、という方式で開発ツールを導入します。

`package.json`にて、例えば `prettier` プロパティがこうなっているとします:

```json
  "prettier": "@aromarious/prettier-config",
```

「`prettier`パッケージは設定として`@aromarious/prettier-config`というパッケージを参照します」という意味です。他のツールも同様に設定をパッケージとしてまとめ、そのパッケージを参照する形で設定を行います。

## 1. commitlint の導入

コミットメッセージのフォーマットを統一するために [commitlint](https://commitlint.js.org/) を導入します。

1. 設定パッケージを作成します。`turbo`コマンドの `gen init` を使用して、commitlint の設定を生成します。

   ```sh
    pnpm turbo gen init -a commitlint-config '@commitlint/cli @commitlint/config-conventional commitlint-config-gitmoji conventional-changelog-gitmoji-config'
    mv package/commitlint-config tooling
   ```

   `package/commitlint-config` ディレクトリが必要な設定ファイルとともに生成されて、`pnpm install` で依存関係がインストールされます。

   `commitlint-config` を`package`から`tooling` ディレクトリに移動します。

2. `tooling/commitlint-config/src/index.ts` を編集して、必要なルールを設定します。
3. `tooling/commitlint-config/tsconfig.json` を編集して、`dist/index.js` を出力するように設定します。
4. `pnpm -F @aromarious/commitlint-config build`を実行して、`dist/index.js`が正しく生成されていることを確認します。

5. ルートの `package.json` に `commitlint` の設定パッケージと、設定を追加します。

   ```json
     "devDependencies": {
       "// ...existing-package...": "",
       "@aromarious/commitlint-config": "workspace:\*",
       "// ...existing-package...": "",
     },
     "commitlint": {
       "extends": [
         "@aromarious/commitlint-config",
       ]
     }
   ```

6. 依存関係をインストールします。

```sh
pnpm install
```

7. 動作確認をします。

   ```sh
   echo 'feat: add a feature' | pnpm commitlint
   pnpm commitlint --print-config
   ```

8. コミット時に自動でチェックするため、[husky](https://typicode.github.io/husky/) を使って git hook を設定します。

   ```sh
   pnpm -w add -D husky
   pnpm husky init
   echo 'npx commitlint --edit $1' > .husky/commit-msg && chmod +x .husky/commit-msg
   ```

## 2. lint-staged の導入

コミット前に自動でコードを整形・検査するために [lint-staged](https://github.com/okonet/lint-staged) を導入します。

`lint-staged`はパッケージで提供される設定を認識できないため、パッケージは作成せず、`package.json`に直接設定を記述します。

1. `lint-staged` を開発依存関係としてインストールします。

   ```sh
   pnpm -w add -D lint-staged
   ```

1. `package.json` に `lint-staged` の設定を追加します。

   ```json
   "lint-staged": {
     "*.{js,ts,tsx}": [
       "eslint --fix",
       "prettier --write"
     ],
     "*.{json,md}": [
       "prettier --write"
     ]
   }
   ```

1. husky の pre-commit フックに lint-staged を追加します。

   ```sh

    echo 'npx lint-staged' > .husky/pre-commit && chmod +x .husky/pre-commit

   ```

## 3. Docker の設定

`docker-compose` を使用して、必要なサービスを定義します。

1. `tooling/docker`ディレクトリを作成します。

```sh
mkdir tooling/docker
```

2. 設定を提供するというわけではありませんが、他と統一的な扱いにするためにパッケージの体裁だけ整えます。
   `package.json`を作成し、以下の内容にします。

   ```json
   {
     "name": "@aromarious/docker"
   }
   ```

3. `tooling/docker/docker-compose.yml` を作成します。開発に必要なサービスを定義します。このリポジトリではpostgresを使用する設定をしてあります。

4. `docker-compose.yml`に環境変数を利用する場合は、プロジェクトルートに `.env` ファイルを作成して定義しておき、それを使います。
5. Dockerのビルドと起動を簡単にするために、`package.json`にスクリプトを追加します。

   ```json
   "scripts": {
     "docker:up": "docker-compose -f tooling/docker/docker-compose.yml up -d",
     "docker:logs": "docker-compose --file tooling/docker/docker-compose.yml logs",
     "docker:down": "docker-compose -f tooling/docker/docker-compose.yml down"
   }
   ```

---

以上で T3 Turbo の開発ツールの追加が完了しました。このリポジトリはこれらの設定が完了した状態で提供されています。
